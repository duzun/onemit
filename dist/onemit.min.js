/*
 MIT
   @version 2.2.0
   @repo    https://github.com/duzun/onemit
*/
(function(m,n){"object"===typeof exports&&"undefined"!==typeof module?module.exports=n():"function"===typeof define&&define.amd?define(n):(m="undefined"!==typeof globalThis?globalThis:m||self,m.OnEmit=n())})(this,function(){function m(a){if(a)return v(a,m.prototype)}function n(a){if(!(this instanceof n))return new n(a);void 0==a&&(a="");"string"==typeof a&&(a={type:a});v(this,a);this.timeStamp=Date.now()}function q(a,c){var d=this._callbacks||(this._callbacks={}),e=a.type||String(a);return d[e]||
c&&(d[e]=[])||[]}function A(a,c,d){var e=m.Promise||w,f=this;d=+d;var g=x(d);return new e(function(b,h){g(function(){try{b(a.apply(f,c))}catch(l){h(l)}},d)})}function x(a){var c=a?m.setTimeout||C:m.setImmediate||D;c||a||(c=x(1));return c}function v(a,c){for(var d in c)r.call(c,d)&&(a[d]=c[d]);return a}function z(a){return a instanceof Function||"function"==typeof a}var p="undefined"==typeof globalThis?"undefined"==typeof global?self:global:globalThis,r={}.hasOwnProperty,E=r.bind,B=[],t=B.slice,F=
B.splice,w="undefined"!=typeof Promise?Promise:p.Promise;p="undefined"!==typeof self&&z(self.setTimeout)?self:p;z(p.setTimeout)||"undefined"!==typeof require&&(p=require("sdk/timers"));var C=p.setTimeout,D=p.setImmediate;v(n.prototype,{type:"*",toString:function(){return this.type}});v(m.prototype,{on:function(a,c){q.call(this,a,!0).push(c);return this},only:function(a,c){var d=q.call(this,a,!0);0>d.indexOf(c)&&d.push(c);return this},once:function(a,c,d){function e(){delete e.never;this.off(a,e);
c.apply(this,arguments)}e.fn=c;d&&(e.never=d);return this.on(a,e)},when:function(a,c){var d=this;return new (m.Promise||w)(function(e,f){var g=function(b){for(var h=arguments.length,l=Array(1<h?h-1:0),k=1;k<h;k++)l[k-1]=arguments[k];b.args=l;e(b);f=void 0};d.once(a,g,f);(c=+c)&&x(c)(function(){if(f){var b=Error("OnEmit.when(".concat(a,") timeout after ").concat(c));b.type="timeout";f(b);d.off(a,g)}},c)})},off:function(a,c){var d=this,e=this._callbacks;if(!e)return this;if(0==arguments.length){if(e){for(a in e)r.call(e,
a)&&this.off(a);this._callbacks={}}return this}var f=e[a];if(!f)return this;var g=[];if(1==arguments.length)for(delete e[a],e=f.length;e--;){if(f[e]){var b=f[e].never;b&&g.push(b)}}else for(e=f.length;e--;)if(b=f[e],b===c||b.fn===c)(b=b.never)&&g.push(b),F.call(f,e,1);var h=g.length;h&&x()(function(){for(var l=0;l<h;++l){var k=g[l];k&&k.call(d,a)}});return this},emit:function(a,c,d){var e=[],f=new n(a);f.result=e;var g;if(!(g=this._callbacks))return f;var b=g[f.type];g=g["*"];if(b&&b.length)b=g&&
g.length?b.concat(g):t.call(b,0);else if(g&&g.length)b=t.call(g,0);else return f;g=t.call(arguments,0);g[0]=f;for(var h=0,l=b.length;h<l;++h){var k=b[h];delete k.never;k=k.apply(this,g);void 0!==k&&e.push(k)}return f},emitAfter:function(a,c,d,e){var f=m.Promise||w,g=[],b=+("number"==typeof a),h=new n(arguments[b]);h.result=g;var l;if(!(l=this._callbacks))return f.resolve(h);var k=l[h.type];l=l["*"];if(k&&k.length)k=l&&l.length?k.concat(l):k;else if(l&&l.length)k=l;else return f.resolve(h);l=k.length;
var u=t.call(arguments,b);u[0]=h;for(b?b=0:a=0;b<l;++b){var y=k[b];delete y.never;g[b]=A.call(this,y,u,a)}return f.all(g).then(function(G){h.result=G;return h})},emitAsync:function(a,c,d){var e=m.Promise||w,f=new n(a),g=[];f.result=g;var b;if(!(b=this._callbacks))return e.resolve(f);var h=b[f];b=b["*"];if(h&&h.length)h=b&&b.length?h.concat(b):h;else if(b&&b.length)h=b;else return e.resolve(f);b=h.length;var l=t.call(arguments,0);l[0]=f;for(var k=0;k<b;++k){var u=h[k];delete u.never;g[k]=A.call(this,
u,l)}return e.all(g).then(function(y){f.result=y;return f})},bind:function(a){var c=m.prototype,d;for(d in c)r.call(c,d)&&z(c[d])&&(a[d]=E.call(c[d],this));return a},hasListeners:function(a){a=q.call(this,a,!1);return!(!a||!a.length)},hasListener:function(a,c){!c&&a&&(c=a,a="*");if("*"!=a){var d=q.call(this,a,!1);return!(!d||!~d.indexOf(c))}d=this._callbacks;for(var e in d)if(r.call(d,e)&&-1<d[e].indexOf(c))return!0;return!1},listeners:q});m.Event=n;return m});
